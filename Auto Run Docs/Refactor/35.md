# Refactor Task 35: src/main/utils/shellDetector.ts

## Summary
The `shellDetector.ts` file is a compact 83-line utility module with excellent test coverage (493 lines). The file has one significant dead code issue (`getShellCommand` export never used in production), notable type duplication (`ShellInfo` duplicated 4 times), and duplication of the `which`/`where` platform detection pattern across 5 files in the codebase.

## Dead Code
- **`getShellCommand()` function (lines 69-82):** Exported but only used in tests - never imported anywhere in production code. This is dead code that could be removed or unexported.

## Deprecated Patterns
- None found. The file uses modern async/await patterns and the safe `execFileNoThrow` utility correctly.

## Duplication
- **`ShellInfo` interface duplicated 4 times:**
  - `src/main/utils/shellDetector.ts:3-8` (canonical definition)
  - `src/main/preload.ts:53-58` (copy)
  - `src/renderer/types/index.ts:499-504` (copy with export)
  - `src/renderer/global.d.ts:60-65` (copy)

  All 4 definitions are identical and should be consolidated into `src/shared/types.ts`.

- **Platform-dependent `which`/`where` command pattern duplicated 5 times:**
  - `src/main/utils/shellDetector.ts:39`
  - `src/main/ipc/handlers/agents.ts:105`
  - `src/main/utils/cliDetection.ts:48`
  - `src/main/agent-detector.ts:343`
  - `src/cli/services/agent-spawner.ts:97`

  All use identical pattern: `const command = process.platform === 'win32' ? 'where' : 'which';`
  Should extract to shared utility like `getWhichCommand()`.

## Code Smells
- **Sequential shell detection (lines 25-28):** Uses sequential `for...of` loop to detect shells. Could use `Promise.all()` for parallel detection, improving startup performance (5 sequential shell checks vs 5 parallel checks).

## Type Safety Issues
- None found. The file has proper type annotations for all functions and interfaces. No `any` types, unsafe casts, or non-null assertions.

## Recommended Refactoring

1. **Remove or unexport `getShellCommand()`** (Low priority)
   - The function is never used in production
   - Either delete it entirely or keep it as private (non-exported) for potential future use
   - Also remove the corresponding tests if deleting

2. **Move `ShellInfo` to `src/shared/types.ts`** (Medium priority)
   - Add `ShellInfo` export to `src/shared/types.ts`
   - Update all 4 locations to import from shared
   - Reduces duplicate type definitions

3. **Extract `getWhichCommand()` utility** (Medium priority)
   - Create function: `export const getWhichCommand = () => process.platform === 'win32' ? 'where' : 'which';`
   - Add to a shared utilities file (e.g., `src/shared/platformUtils.ts`)
   - Update all 5 locations to use the shared utility

4. **Parallelize shell detection** (Low priority)
   - Replace sequential loop with `Promise.all(shells.map(...))`
   - Minor performance improvement during app startup
   - Consider if order matters (currently returns in predefined order)

## Estimated Impact
- **Risk Level:** Low - the file is well-tested with comprehensive test coverage
- **Testing Considerations:**
  - Existing test suite (493 lines) covers all current functionality
  - If removing `getShellCommand()`, remove ~100 lines of tests for it
  - Platform-specific tests exist for Windows/macOS/Linux behavior
- **Dependencies:** Only imported by `src/main/ipc/handlers/system.ts` (the `detectShells` function)
